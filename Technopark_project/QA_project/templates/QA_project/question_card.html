{% load static %}
{% if detailed %}
<div id="question-{{ question.id }}" class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col d-flex flex-column justify-content-between">
{% endif %}
<div class="card">
    <h5 class="card-header">
        {% if question.is_solved %}
            Problem solved
            <img src="{% static 'resources/pictures/green_galochka.png' %}" style="max-width: 3%;" alt="Solved" class="img-fluid mb-2">
        {% elif question.is_closed %}
            Closed
            <img src="{% static 'resources/pictures/red_cross.png' %}" style="max-width: 3%;" alt="Closed" class="img-fluid mb-2">
        {% else %}
            Open
        {% endif %}
    </h5>
    <div class="card-body">
        <div class="row">
            <div class="col-2">
                <div style="height: 100px;" class="border mb-2 w-100">
                    <img src="{% static 'resources/pictures/question.png' %}" alt="Question" class="img-fluid">
                </div>
                  <div class="like-dislike-buttons">
                      <button class="btn btn-outline-success like-btn">üëç <span class="count">{{ question.likes_count }}</span></button>
                      <button class="btn btn-outline-danger dislike-btn">üëé <span class="count">{{ question.dislikes_count }}</span></button>
                  </div>
            </div>
            <div class="col d-flex flex-column justify-content-between">
                <div>
                    <a href="{% url 'question' question.id %}">
                        <h4 class="card-title">{{ question.title }}</h4>
                    </a>
                    <p class="card-text">{{ question.text|truncatewords:30 }}</p>
                </div>
            </div>
        </div>
    </div>
    <div class="card-footer">
        <div class="row">
            <div class="col">
                <a href="{% url 'question' question.id %}">Answers ({{ question.answers_count }})</a>
            </div>
            <div class="col">
                <span>Tags:</span>
                {% for tag in question.tags.all %}
                    <a href="{% url 'tag' tag.name %}" class="badge rounded-pill text-bg-primary">{{ tag.name }}</a>
                {% empty %}
                    <span class="text-muted">No tags</span>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% if detailed %}
            </div>
        </div>
    </div>
</div>
{% endif %}


<script>
document.addEventListener('DOMContentLoaded', function () {
    console.log("Question like script loaded");

    const card = document.getElementById('question-{{ question.id }}');
    if (!card) {
        console.error("Card question not found");
        return;
    }
    const questionId = '{{ question.id }}';
    const likeBtn = card.querySelector('.like-btn');
    const dislikeBtn = card.querySelector('.dislike-btn');
    const likeCount = likeBtn.querySelector('.count');
    const dislikeCount = dislikeBtn.querySelector('.count');

    likeBtn.addEventListener('click', function () {
        sendLikeDislike('like');
    });
    dislikeBtn.addEventListener('click', function () {
        sendLikeDislike('dislike');
    });

    function sendLikeDislike(type) {
        fetch('/like-question/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `id=${questionId}&type=${type}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.likes !== undefined && data.dislikes !== undefined) {
                likeCount.textContent = data.likes;
                dislikeCount.textContent = data.dislikes;
            } else {
                alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ª–∞–π–∫–∞/–¥–∏–∑–ª–∞–π–∫–∞');
            }
        }).catch(error => {
            console.error('Fetch error:', error);
        });
    }

    function getCookie(name) {
        const cookies = document.cookie.split('; ');
        for (let cookie of cookies) {
            if (cookie.startsWith(name + '=')) {
                return cookie.split('=')[1];
            }
        }
        return null;
    }
});
</script>